---
import { formatDateTime } from '../utils/format';

const {
  bit,
  Content,
  author = 'Whono'
} = Astro.props;

const tags = bit.data.tags ?? [];
const placeTag = tags.find((t: string) => t.toLowerCase().startsWith('loc:')) ?? '';
const placeText = placeTag ? placeTag.slice(4).trim() : '';
const normalTags = tags.filter((t: string) => !t.toLowerCase().startsWith('loc:'));
const tagsText = normalTags.map((t: string) => `#${t}`).join(' ');
const base = import.meta.env.BASE_URL ?? '/';
const withBase = (path: string) => {
  if (!path) return path;
  if (/^(?:[a-z]+:)?\/\//i.test(path) || path.startsWith('data:')) return path;
  const baseNormalized = base.endsWith('/') ? base : `${base}/`;
  const clean = path.startsWith('/') ? path.slice(1) : path;
  return `${baseNormalized}${clean}`;
};
type BitImage = { src: string; width: number; height: number; alt?: string };
const images = (bit.data.images ?? []) as BitImage[];
const imageItems = images.map((image) => ({
  ...image,
  src: withBase(image.src)
}));
const firstImage = imageItems.length === 1 ? imageItems[0] : null;
const totalImages = imageItems.length;
const wideIndex = totalImages > 1 && totalImages <= 4 && totalImages % 2 === 1 ? 0 : -1;
---

<article class="bit-card" data-bit data-slug={bit.data.slug ?? bit.id}>
  <div class="bit-author">
    <div class="avatar" aria-hidden="true">{author[0] ?? 'W'}</div>
    <div class="name">{author}</div>
  </div>

  <div class="bit-body">
    <Content />
  </div>

  {firstImage ? (
    <div class="bit-media">
      <img
        src={firstImage.src}
        alt={firstImage.alt ?? ''}
        width={firstImage.width}
        height={firstImage.height}
        loading="lazy"
      />
    </div>
  ) : imageItems.length > 1 ? (
    <div class="bit-media bit-media--grid">
      <div class="bit-media-grid">
        {imageItems.slice(0, 4).map((image, index) => (
          <div class={`bit-media-item${index === wideIndex ? ' bit-media-item--wide' : ''}`}>
            <img
              src={image.src}
              alt={image.alt ?? ''}
              width={image.width}
              height={image.height}
              loading="lazy"
            />
            {index === 3 && imageItems.length > 4 ? (
              <span class="bit-media-more">+{imageItems.length - 4}</span>
            ) : null}
          </div>
        ))}
      </div>
    </div>
  ) : null}

  <div class="bit-meta">
    <div class="bit-tags">
      {placeText ? (
        <span class="bit-tag bit-tag--place">
          <span class="bit-tag-icon" aria-hidden="true">üìç</span>
          <span class="bit-tag-text">{placeText}</span>
        </span>
      ) : null}
      {tagsText ? <span class="bit-tag bit-tag--normal">‚ù§ {tagsText}</span> : null}
    </div>
    <div>{formatDateTime(bit.data.date)}</div>
  </div>
</article>
