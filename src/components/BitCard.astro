---
import { formatDateTime } from '../utils/format';

const {
  bit,
  Content,
  author = 'Whono'
} = Astro.props;

const tags = bit.data.tags ?? [];
const placeTag = tags.find((t: string) => t.toLowerCase().startsWith('loc:')) ?? '';
const placeText = placeTag ? placeTag.slice(4).trim() : '';
const normalTags = tags.filter((t: string) => !t.toLowerCase().startsWith('loc:'));
const tagsText = normalTags.map((t: string) => `#${t}`).join(' ');
const base = import.meta.env.BASE_URL ?? '/';
const withBase = (path: string) => {
  if (!path) return path;
  if (/^(?:[a-z]+:)?\/\//i.test(path) || path.startsWith('data:')) return path;
  const baseNormalized = base.endsWith('/') ? base : `${base}/`;
  const clean = path.startsWith('/') ? path.slice(1) : path;
  return `${baseNormalized}${clean}`;
};
const imageSrc = bit.data.image ? withBase(bit.data.image) : null;
const imageAttrs =
  bit.data.imageWidth && bit.data.imageHeight
    ? { width: bit.data.imageWidth, height: bit.data.imageHeight }
    : {};
---

<article class="bit-card" data-bit data-slug={bit.data.slug ?? bit.id}>
  <div class="bit-author">
    <div class="avatar" aria-hidden="true">{author[0] ?? 'W'}</div>
    <div class="name">{author}</div>
  </div>

  <div class="bit-body">
    <Content />
  </div>

  {imageSrc ? (
    <div class="bit-media">
      <img src={imageSrc} alt="" loading="lazy" {...imageAttrs} />
    </div>
  ) : null}

  <div class="bit-meta">
    <div class="bit-tags">
      {placeText ? (
        <span class="bit-tag bit-tag--place">
          <span class="bit-tag-icon" aria-hidden="true">üìç</span>
          <span class="bit-tag-text">{placeText}</span>
        </span>
      ) : null}
      {tagsText ? <span class="bit-tag bit-tag--normal">‚ù§ {tagsText}</span> : null}
    </div>
    <div>{formatDateTime(bit.data.date)}</div>
  </div>
</article>
